# 硬盘分区和格式化
## 场景
服务器硬盘容量耗尽，为保证数据完整性等，需要新插入一块硬盘，给服务器扩容。如果服务器不支持热插拔硬盘，需要关闭服务器，再将硬盘插入。我们演示在虚拟机上安装，虚拟机不支持热插拔，需要先关机再演示。然后给硬盘进行分区、格式化等操作。

## 安装新硬盘
- 关闭虚拟机
- 安装新硬盘
  - 此时的硬盘还无法使用，还需要进行分区、格式化、挂载后才能使用。


## 硬盘分区
在Linux系统中，都是以文件方式管理，/dev目录下存放硬件设备，会在服务器启动时自动识别。

### 硬盘分区模式
>MBR模式
- 主分区不超过4个
- 单个分区容量最大2TB


>GPT模式
- 分区表中最多支持128个主分区
- 单个分区最大18EB
  - 扩展：1EB=1024PB, 1PB=1024TB, 1TB=1024GB
- 缺点：不适合安装x86系统（32位操作系统）

### 硬盘分区步骤
>MBR模式分区
- fdisk [选项] [目录]
  - fdisk :
  - fdisk -l ：会出现目前的硬盘情况。
    - 新添加的硬盘信息末尾会出现“Disk /dev/sdb doesn't contain a valid partition table”，表示该硬盘已经被系统识别，但是还未进行分区，暂时无法存储数据，需要进行**分区**操作。有的不会出现。
    - 未分区硬盘不会有磁盘分区表。
  - 硬盘分区：fdisk 要分区的硬盘路径，比如：fdisk /dev/sdb。
    - 写硬盘分区指令：
      - m ：打印菜单
      - u ：切换到sectors
      - n ：进入分区模式
        - p ：primary 主分区
          - Partiton number(1-4)：1，指定分区编号，1-4是预留给主分区或者扩展分区。
          - cylinder number（1-1044，default 1）:sectors中不会出现这个，需要退出去，输入u，进入sectors才会出现扇区起始和终止位置的输入。
        - e ：extension 扩展分区（只能有一块扩展分区）
          - n ：继续分区——逻辑分区 和 主分区
        - 注意：1-4是主分区和扩展分区的编码，逻辑分区要从5开始。
      - 指定扇区的起始和终止位置
        - 注意：不同Linux可能有差别一下提示可供选择，或者直接写**fidisk -u=sectors /dev/sdb**
         ```
         WARNING: DOS-compatible mode is deprecated. It's strongly recommended to
         switch off the mode (command 'c') and change display units to
         sectors (command 'u').
         ```
         - 写完终止位置回到Command（for help），即最初进行分区的位置，也是fdisk第一次执行后的位置。
      - p ：此时通过p命令可以查看已经分配的分区
      - 重复执行n 命令之后的内容，添加扩展分区；然后给扩展分区添加逻辑分区
      - d ：删除已经存在的分区。
        - 逻辑分区是在扩展分区内部的，删除扩展分区也会删除逻辑分区。
      - w ：保存。w之前的操作都相当于是在设计图纸，真正保存到磁盘是在w 这一步。
    - 查看分区目录：fdisk -l

>GPT模式分区

**parted** 命令既可以给硬盘进行MBR模式分区，又可以给硬盘进行GPT模式分区。而 **fdisk** 命令只能给硬盘进行MBR模式分区。

- parted ：进入parted中进行分区，默认在第一块硬盘中
  - help ：查看帮助
  - select 磁盘目录：切换到要进行分区的磁盘目录下。比如：select /dev/sdc
  - 模块label 分区表类型：给目标磁盘指定 **分区表** 的类型
    - MBR模式分区表：msdos
    - GPT模式分区表：gpt
    - **注意**：在fdisk分区中没有这一步，因为fdisk只能进行MBR模式分区。

  - print ：查看当前分区情况
    - print all ：查看所有分区情况
  - GPT模式分区两种方式：交互模式 和 命令模式
    - 交互模式：每操作一步系统会有提问
    - 命令模式：命令 选项 ，一顿操作

>GPT 之 交互模式
- 分区：mkpart
  - 询问
    - 分区名称：可以不写
    - 文件系统类型：默认选择，学习了**格式化**内容之后可以自己格式化
    - 开始：从第几MB开始。fdisk中指扇区数据块的编号。
      - 1：从1开始，不要从 0 开始，会有**4K**对齐的问题。
        - 4K对齐：<https://baike.sogou.com/v62954073.htm?fromTitle=4K对齐>
    - 结束：第几MB结束，不包含。比如：2000MB，表示不包含2000MB。略。
    - print : 查看刚刚添加的分区。


>GPT 之 命令模式
- 分区：mkpart 分区名称 分区开始位置 分区结束位置
  - 注意：使用命令模式时，分区名称不能省略。交互模式可以省略。
- 删除分区：rm 分区编号
- 指定开始结束位置单位：unit 单位。比如：unit GB。
- 退出分区表：quit
  - fdisk中有一个 **w** 指令，表示写入分区表，但是parted中分区是即时生效的，不需要最后写入。

``
注意，分区重叠：扇区开始位置和结束为止，不同分区之间最好不要重叠。第一个分区扇区数据块结束编码 + 1 = 第二块扇区数据块开始编码。
``

## 硬盘（分区）格式化
格式化是指写入文件系统。
parted 可以进行简单的格式化，mkfs 可以进行MBR 和 GPT模式的格式化。

- mkfs 格式化命令
  - mkfs.文件系统名称 要格式化的硬盘分区目录：
    - 比如：mkfs.ext3 /dev/sdb1
  - mkfs -t 文件系统名称 要格式化的硬盘分区目录
    - mkfs -t ext4 /dev/sdb2


- 格式化对象
  - MBR模式中的**主分区**和**逻辑分区**，不能格式化扩展分区。
  - GPT模式不区分主分区和扩展分区，多有分区都可以格式化。
- 查看格式化后的文件系统类型
  - fdisk没办法查看格式化后的GBT的文件系统类型，需要使用parted命令中的print指令查看。

## 挂载分区
挂载点：可以理解为Windows中的盘符
挂在后才可以使用，不挂在不能使用。
系统提供了一些挂载点，一般我们将磁盘挂载到mnt目录下。
>挂载操作
- mount 临时挂载
  - 创建挂载点：mkdir -p /mnt/imook 
  - 挂载：mount /dev/sdb1 /mnt/imook
  - 重启服务器后，挂载失效

- 自动挂载
  - 重启服务器后自动挂载
  - 在配置文件fstab末尾添加内容：vim + /etc/fstab
    - 格式：设备名称 挂载点 文件系统类型 defaults 0 0


>卸载操作
- umount /mnt/imook


## swap分区
给硬盘添加交换分区

- 建立普通Linux分区
  - sdb6，   ID 是 83  ，分区类型16进制编码。
    - 分区类型：Linux分区，Linux交换分区等
- 修改分区类型的十六进制编码
  - fdisk
    - t ：选择分区编号
      - 分区编号
      - 十六进制编码，键入L查看十六进制编码，82是交换分区编码
    - p ：查看id 变为了82
    - w ：保存
- 格式化交换分区
  - mkswap /dev/sdb6 
- 启用交换分区
  - 启用：swapon /dev/sdb6
  - free：查看swap加载状况
  - 停止swap分区：swapoff /dev/sdb6
- 